# ArcGIS学习笔记



##### 关于工作目录和默认地理数据库

-   ***默认工作目录是当前`.mxd`文件所在的文件夹(?)好像可以单独设置?***
-   在工作目录里可以看到需要导入的文件, 而不用另外链接文件夹或者在系统文件夹里把它们拖到ArcGIS里
-   默认地理数据库是默认输出的位置. 

##### 导入`pre`的.tiff格式文件

-   如何导入.tif格式文件
-   查看.tif格式文件的属性: 坐标系, 分辨率, 等
-   为图层设置不同的色带. 
    -   连续色带(选项里的`拉伸`)
    -   选项: `已分类`, 设置分层色带. 设置中断值
    -   由于中国以外的数据被设置成了0, 因此被归入了<100mm的层. 我们要给他单列一个层. 

##### 导入`dem_1km`的栅格数据文件

-   添加数据->链接文件夹, 或者直接把文件夹里的所有文件选中, 再一起拖进去. 或者把工作目录设成数据所在的文件夹, 直接在ArcGIS的文件管理串口操作. 
-   导出为.tiff格式的数据: 数据->导出数据. 可以选择分辨率, 文件名和导出位置. 

##### 导入`res1_4m`的点矢量数据

-   选中文件夹里的.shp文件, 拖进去就行
-   会显示*缺少空间参考信息*, 先不用管. (因为会默认是WGS1984投影. 如果此时图层的投影恰好也是WGS1984就没问题, 否则就不行)
-   查看它的属性. ->源, 可以查看数据的范围. 也可以发现它的坐标系是<未定义>的. 
-   查看属性表. 
-   改变显示方式. 属性->符号系统->类别: 唯一值->值字段: `ADCLASS`->添加所有值. 这样就可以按照属性`ADCLASS`中不同的类设置不同的符号了. 右键某个符号, 可以选择`所选符号的属性`或者`所有符号的属性`, 对它们进行修改. 

##### 导入线数据: `hyd1_4m`

-   还是找到.shp文件, 把它拖进去
-   按照类似的方法改变显示

##### 面数据. `国界与省界`->`china_Albers`

-   导入方法类似. 
-   属性->源, 查看它的范围, 投影, 等
-   打开属性表. 
-   可以发现辽宁省的很多小岛都被算成单独的要素, 要把它合并. 数据管理->Generalization->融合Dissolve, 选择要融合的字段. 这里我们选择`NAME`. **注意融合的时候不能选中任何一个对象**, 如果已经选择了, 要用选择工具在空白的地方点一下以取消选择, 否则只会对选择的那个对象进行处理. 
-   对属性表进行操作. 
    -   添加字段. 打开属性表->左上角的按钮->添加字段
    -   编辑字段. 注意添加字段后是没有办法对其进行修改的. 只能编辑器->开始编辑->选中要编辑的图层, 才能对其进行修改. 如果要添加字段则必须先停止编辑. **总之, 添加字段和修改字段不能同时进行.** 
    -   按属性选择. 左上角按钮->按属性选择. 弹出的对话框里会给出你所有的属性字段. 选择某个属性字段后点`获取唯一值`, 可得到这个字段的所有值. 如果我们要选择面积大于某个值的所有省份, 只要点`Shape_area`再`获取唯一值`, 对你想要的属性字段和值进行逻辑运算即可. 
    -   删除内容. 选择要删除的内容, 在**编辑**状态下才能对其进行删除. 
    -   给属性表添加Excel中的数据. 用`连接与关联`选项. 要注意的一点是**ArcGIS只能添加.csv格式的数据**, 所以要先把Excel文件另存为.csv文件. 左上角按钮->连接与关联->连接. 注意选择基于的字段. **注意基于的字段名称必须完全一致**, 否则会将不匹配的内容另起一行. 
    -   如果不匹配, 也可以将属性表导出成.csv(.txt?)格式, 用Excel打开, 在Excel中手动匹配数据, 再在ArcGIS中新建一个字段, `开始编辑`, 然后把那一列需要导入的数据直接复制过去. ***(但是这里我并没有搞清楚怎么导出成.txt格式的数据)***





##### 栅格数据的基本功能和处理

###### 1. 裁剪

-   数据管理工具->栅格->栅格处理->裁剪
-   这里注意要选择`使用输入要素裁剪几何`, 否则会按输入要素的外接矩形进行裁剪. 
-   注意选择的输入要素和裁剪要素都要处于未选中其中的任何一个元素的状态, 否则就只会对选中元素进行操作. 
-   ***输入要素貌似必须是矢量数据, 不能是栅格数据?***

###### 2. 按掩膜提取

-   Spatial Analyst工具->提取分析->按掩膜提取
-   有时候传统的裁剪工具用不了, 就改用这个方法. 
-   ***这个掩膜好像仅限于栅格数据? 不是很清楚hhh***

###### 3. 重采样

-   数据管理工具->栅格->栅格处理->重采样
-   对栅格的空间分辨率进行调整
-   输出像元大小可以手动指定, 也可以设置成和已有的某个图层相同. 

###### 4. 重分类

-   3D Analyst工具->栅格重分类->重分类, 或者, Spatial Analyst工具->重分类->重分类, 从这两个地方打开的工具是一样的. 
-   把某个范围的值设定成一个新值
-   默认的分类方法已经按照色带的划分给好了. 如果想手动设置也可以. 

###### 5. 栅格计算器

-   Spatial Analyst工具->地图代数->栅格计算器
-   可以用来得到复合指标, 比如用降水量和蒸发量计算干旱度等. 
-   除了加减乘除, 还有条件分析, 逻辑运算和各种数学函数, 这个可以研究一番. 
-   这里并不需要参与计算的栅格分辨率一致. ***貌似***遵循这个原则: 输出的栅格取向与第一个栅格一致, 输出栅格的分辨率和位置与输入的最大分辨率的栅格一致. 

##### 矢量数据的基本操作

###### 1. 栅格提取至点

-   Spatial Analyst工具->提取分析->~
-   比如我有降水量的栅格数据和省会城市的点数据, 那么可以利用此功能获得每个城市(那个点)的降水量数据. 
-   工具的名称叫**值提取至点**, 会生成一个新文件, 提取出来的值作为一个新字段被加进去. 另外还有一个工具叫**多值提取至点**, 可以有多个输入栅格, 会直接在原来的点数据上添加多个新字段. 
-   

###### 2. 分区统计

-   Spatial Analyst工具->区域分析->分区统计
![分区统计](\image\分区统计.png)
-   比如, 用来提取某个省的平均降水量, 需要输入一个栅格(降水量数据)和一个面(省级行政区数据)
-   第一行选择分区依据, 这里是中国省份的矢量数据
-   第三行选择待统计的值
-   得到的是一个栅格数据集, 其中每个省份(分类依据)对应位置的栅格的值是算出来的值. 这个栅格和第三行输入的栅格分辨率是一样的, 只不过栅格里的值变化了. 

###### 3. 空间连接

-   这个功能可以用来统计每个区域各有多少点. (需要两个矢量)
-   目标要素输入用于分区的面数据, 连接要素输入待统计的点数据
-   生成的图层中的`Join-Count`字段, 即为该区域内点的数目

##### 矢量转栅格

在**转换工具**工具箱中有很多转换的功能, 可以自行探索一番. 尤其是**由栅格转出**和**转为栅格**两个, 在矢量和栅格互转会用到. 

注意, '线转栅格'的工具叫'折线转栅格' (Polyline to Raster)

-   可以手动指定输出栅格的像元大小, 也可以直接用ArcGIS给的默认值. 
-   点击下面的`环境`, 可以设置输出的范围等等. (栅格默认范围是矢量数据的外接矩形, 没有矢量的位置会被赋值成NoData)
-   ->处理范围, 可以设置成和某图层相等, 也可以手动输入经纬度数据. 

##### 扫描矢量化: 数据采集

1.  第一步, 新建一个图层, 用来容纳被录入的数据
    -   点, 线, 多边形被放在不同的图层
2.  右侧Catalog(目录)->在自己关联的文件夹上点右键->新建->Shapefile, 记得选择要素类型(点, 线, 多边形, etc.). 投影类型可以在一开始选择, 或者后面再定义也行.
    -   录入数据之前, 先在工具栏上右键->调出'编辑器'工具条
3.  开始编辑->创建要素->然后就可以录入数据了

不过更多时候我们是根据已有的地图, 扫描上面的数据. 这时可以用半自动追踪的功能

1.  二值化. ArcGIS不能直接处理彩色的图. 首先得单独打开其中一个通道(最明显的那个), 再在属性->符号系统->已分类, 根据一个合适的阈值将图象二值化. 
2.  工具栏上右键->调出ArcScan工具条. 如果这时候ArcScan工具条是灰色的, 要在自定义->扩展模块中勾选ArcScan
3.  新建一个矢量图层, 再调出'编辑器'工具条, 开始编辑. 
4.  在ArcScan工具条中选择'矢量化追踪, 即可. 

全自动矢量化: 效果不是特别好, 尤其是后期处理比较麻烦, 除非原始图象质量非常好. 



##### 地理配准

这里被配准的对象是栅格数据. 如果要对矢量数据进行地理配准, 请看下一条**空间校正**. 

-   比如说我有地图的图片(`.jpg` or `.png`)但图片中并没有地理信息, 就需要进行地理配准. 
-   工具栏处右键->地理配准, 出现地理配准的工具条. 再点击左侧"地理配准"下拉菜单取消"自动校正". 再点击右侧'查看链接表", 打开连接表. 
-   点击"添加控制点". 第一个点击的位置是地图上的位置(这个点要点准), 第二个位置是地图上这个点要被变换到的位置. 由于接下来我们要手动输入"X地图"&"Y地图"数据, 因此第二个点随便点就行. 然后在链接表里手动输入数据即可(单位是米, 要对读取的方里网数据×1000). 
    -   注意是被配准的内容指向基准
    -   如果不是手动输入精确的基准数据, 而是要把被变换的图层'拉到'和基准图层一样的空间参考系, 那么两个点都要点准. 
-   关于地图的坐标. GK投影所用坐标为方里网坐标, x轴为横轴, y轴为纵轴(和地图学上学到的GK投影不一样!), 且无需考虑伪东偏移(即, 地图上给出的方里网和ArcGIS里的坐标系均包含伪东偏移, 因此操作的时候无需考虑). 之后要根据地形图的比例尺和分幅确定它在GK的哪个分度带上. 如果横坐标包含带号, 则投影选择"Beijing 1954 GK Zone 20", 若不包含带号, 则选择"Beijing 1954 GK Zone 20N". 
-   重复添加若干个控制点. 可以在"变换"中选取变换方式. 如果想看到变换后的效果, 打开"自动校正"即可. 
-   校正好了, 左侧"地理配准"下来菜单里点击"更新地理配准"或"校正"即可. 前者会生成`.jgwx`和`.jpg.aux.xml`文件存放配准后的坐标信息, 后者会在地理数据库中生成栅格数据集. 

##### 空间校正

空间校正是针对矢量数据的操作. 

-   '新建位移链接工具'(添加控制点)之前需要开始编辑. 
-   其他操作类似. 

##### 坐标&投影变换

-   首先要分清变换坐标只是为了显示还是为了带进模型里算. 如果只是导出地图看一下, 可以直接更改图层的投影. 
-   注意如果某图层是没有投影的(就会默认它是WGS1984), 这时若改变图层的投影设置, 则这个数据就没法正常显示, 因此要对它定义投影, 方法见下文. 
-   如果是为了带进模型里算, 就要正儿八经地对他进行投影变换. 数据管理工具->投影与变换->栅格->**投影栅格**. 
    -   如果是投影矢量数据, 则为: 数据管理工具->投影与变换->投影
-   Albers投影是个等面积投影, 因此它的分辨率是多少米×多少米. 

##### 定义投影

-   Toolbox->数据管理工具->投影与变换->定义投影. 
-   另外一种定义投影的方法: 运行ArcCatalog, 找到文件, 右键->属性, 在"空间参考"右侧点击"编辑", 即可. 
-   定义投影时会对图像的`.jpg.aux.xml`文件进行修改. 

##### ArcGIS中如何制图

-   根据不同省份新冠确诊数量上色, 不需要先面转栅格再改变符号系统. 直接选择含有确诊病例的矢量文件, 属性->符号系统->显示->数量->**分级色彩**, 可以达到一样的效果. 
-   对布局视图的操作
    -   添加标题. 插入->标题. 右键它->属性->更改符号, 对它的格式进行修改
    -   修改标题文本, 文件->地图文档属性
    -   指北针. 插入就行了. 但是注意入如Albers投影经纬网不是方形的, 也就是说图的上方并不总是正北. 因此这种情况下插入指北针要慎重, 可以考虑用经纬网代替. 
    -   插入图例. 插入比较简单, 但是如果要修改他的格式就有点麻烦. 如果后续对图例内容没有修改的话, 可以右键->转换为图形, 再右键->取消分组, 就可以对每个元素进行单独修改了. 

##### 如何把Excel中的点数据转换为.shp矢量文件

-   虽然可以识别.xls文件, 但是它只能创建点, 而不能将其他列的数据导入属性表, 因此还是要先转换为.csv文件. 
-   **创建XY事件图层**, 输入经纬度对应的字段. Z字段可以不选. 原始数据经纬度的坐标系一般都是WGS1984, 不要考虑已有图层的坐标. 
-   这时候的数据仅为一个图层, 没有object-ID, 因此要**导出数据**成.shp格式的文件, 就可以对其进行选择了. (但是注意, 需要在ArcGIS的功能中用到这个图层的话, 并不需要导出, 比如插值)

##### 关于插值

-   3D Analysis->栅格插值. 这里使用的是克里金法. 
-   关于插值, 在ArcGIS中还有很多不同的方法, 这里可以多搜一搜&探索一番. 

##### 批处理

-   要用的工具, 右键->批处理. 
-   可以先手动设置一个, 然后复制他操作的那一行, 粘贴至Excel, 利用自动填充, 再粘贴回来. 
-   地理数据库里的栅格文件批量导出至.tif: 转换工具->转为栅格->栅格转其他格式. 

##### 关于`.shp`文件

-   `.shp`文件实际上不是一个文件. 其中`.shp`的文件是记录几何信息的, 二进制存储, 不是明码. 
-   `.dbf`用来存放属性信息, 但是可以用Excel打开. 这样就可以利用Excel强大的数据分析功能. **注意分析过程中不要改动`.dbf`文件的结构** (比如改动行列的顺序, 增加/删除行列, 改字段名, etc), 处理之前最好做一个备份, 否则可能造成文件损坏而打不开. 不过其实Excel根本没法保存改动后的`.dbf`文件, 所以倒也不用担心破坏文件结构的问题. 

##### 关于地理数据库

-   分为Personal Geodatabase和File Geodatabase
|            | Personal Geodatabase个人地理数据库 | File Geodatabase文件地理数据库 |
| ---------- | ---------------------------------- | ------------------------------ |
| 最大存储量 | 2GB                                | 1TB                            |
| 后缀       | `.mdb` (一个单独的文件)            | `.gdb` (实际上是一个文件夹)    |
|            | 基于Microsoft Access存储GIS数据    | 不再使用Access的文件结构       |

-   ArcGIS建议用File Geodatabase替代Personal Geodatabase
-   新建一个数据库: 和新建一个Shapefile的操作类似. 在目录->关联的某个文件夹上右键->新建, 即可. 
-   两种数据库都可以新建/导入/导出. 在数据库上右键->新建/导入/导出, 即可. 
-   Geodatabase存储的数据和用`.shp`等方式只是存储方式不同, 操作起来是一样的. (当然可能在某些方面存在细微差别, 不过反正二者互转很方便)

##### 空间查询

查询只能针对矢量数据 (显然, 因为只有矢量数据能分出一个一个的对象)

-   直接在地图上点选. 
-   **按属性选择**: 上方菜单栏->选择->按属性选择, 选择要查询的图层, 然后输入逻辑表达式就行. 
-   **按位置选择**: 上放菜单栏->选择->按位置选择. 注意选择被查询的图层, 查询条件 (以及是否只用选中的对象作为查询条件), 还有二者的空间关系 (在一个下拉菜单中选择), 即可. 

##### 缓冲区

缓冲区的操作有两个入口, 后者的界面更加友好一些. 

1.   分析工具->邻域分析->缓冲区
2.   另一个入口藏得比较深. 上方菜单栏->自定义->自定义模式->在上方选择命令->下拉菜单中找到工具->右侧'缓冲向导'->把它拖到工具条上. 
     -   缓冲区的距离, 可以
         -   输入一个固定数据
         -   根据该要素的某字段而使得不同点有不同的距离 (比如, 不同城市的辐射能力不同, etc)
         -   做多级缓冲区
     -   多边形的缓冲区可以做内缓冲区, 也可以做外缓冲区. 

##### 多边形叠加

分析工具->叠加分析. 根据对结果保留的逻辑不同, 分为以下操作: 

-   相交Intersect: 可以有多个图层参与运算且无先后之分. 空间范围保留的是它们的公共部分, 这部分求交, 每一个多边形都保留了运算前所有图层的属性. 
-   交集取反Symmetrical Difference: 两个要素各自去除它们的公共部分, 再并. 运算后的结果, 每个多边形都保留了两个图层的属性, 虽然实际上每个多边形都只曾属于一个图层, 所以另一个图层的性质就用空值表示. 
-   联合Union: 和相交一样也是多个图层参与运算且无先后之分. 空间范围保留的是所有参与运算图层的并集, 结果中的每一个多边形都保留了运算前所有图层的属性. 如果运算前某个多边形不属于某个图层, 那么这一层的属性在这个多边形中就是空值. 
    -   可以粗略地理解: 相交$\cup$交集取反=联合
-   擦除Erase: 输入要素减去擦除要素. 剩余部分保留输入要素的性质 (擦除要素只有空间数据起了作用, 并没有用到属性数据). 
-   标识Identity: 用标识要素对输入要素做'切割', 属性叠加, 空间范围只保留输入要素的. 
-   更新Update: 输入要素中不和更新要素相交的部分保留, 更新要素全部保留. (相当于更新要素直接'覆盖'在了输入要素上)



##### 待会的工作想法&需要解决的一些问题

-   不考虑海拔这个计算太尼玛离谱了, 但考虑海拔的话又不知道气温直减率是多少. 之前查的那篇文献, 北京地区正好在两个秋季气温直减率相差悬殊地区的交界处, 根本没法参考. 采用0.65℃的话倒不是不行, 但就怕这个值不够好, 搞出新的问题就麻烦了(比如算出反的热岛效应)
-   是否考虑海拔影响? 
    -   如果不考虑海拔的影响的话, 可以把24个时刻的数据都插值了, 加上土地利用类型, 一起导出成.tif格式, 放进Matlab里面计算. 计算的具体内容还要参考一下文献, 不过目前大致打算是研究均温和气温日较差是否与下垫面有关系. 当然这种方法把栅格当作孤立的点, 研究土地利用类型的空间分布对上述两个变量是否有影响还要参考文献. 
    -   考虑海拔的话, 到底是先采集每个站点的海拔数据, 将其化为海平面的数据, 再对气温进行插值; 还是先插值, 再根据每个栅格的海拔数据将每个栅格的气温换算成海平面的数据? 不过好像问题不大. 后者的话可以利用上一步的结果, 多导出一个海拔数据的.tif文件, 就可以放进Matlab里面算了, 稍微简单一些. 
-   关于插值. 我觉得不要在不同方法的选择上太过于纠结, 能插出个不太离谱的结果就行了. 说实话这数据本身就很离谱, 所以更不用过分纠结. **唯一要考虑的点是操作要迅速**(可以试试ArcGIS怎么批量操作? )24个图层实在是太难顶了. 
-   可以试试在Matlab中做插值? 或许操作起来比ArcGIS方便hhh. 搜索`Matlab 二维插值`. 注意一下, 土地利用数据是Albers投影, 导出.tif格式之前记得转成WGS1984. 注意这是离散数据, 采样方法选择最邻近, 不能二次或者双三次. 









第三课: 讲了一些关于投影的基本内容. 关于什么椭球体, KG投影, 基本比例尺地形图分带的问题. 这个基本上都不太记得了, 记得补一下. 

continue at lesson13







### 焦点统计

